<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Battle Overlay</title>
  <style>
    body, html { margin:0; padding:0; overflow:hidden; font-family:'Segoe UI',Arial,sans-serif; background:transparent; color:#fff; position:relative; }
    #centerLine { position:absolute; top:0; bottom:0; left:50%; border-left:3px dotted rgba(0,0,0,.7); transform:translateX(-50%); pointer-events:none; }
    #wrap { position:absolute; bottom:5vh; left:50%; transform:translateX(-50%); display:flex; gap:24px; align-items:center; background:linear-gradient(135deg,rgba(0,0,0,.75),rgba(25,25,25,.7)); border:2px solid rgba(255,255,255,.15); padding:14px 18px; border-radius:14px; box-shadow:0 10px 40px rgba(0,0,0,.45); }
    .block { display:flex; flex-direction:column; min-width:160px; }
    .name { font-size:22px; font-weight:700; text-transform:uppercase; letter-spacing:.08em; }
    .wins { font-size:20px; font-weight:800; line-height:1.2; margin-top:4px; }
    .label { font-size:12px; letter-spacing:.2em; opacity:.7; }
  </style>
</head>
<body>
  <div id="centerLine"></div>
  <div id="wrap"></div>
  <script>
    (() => {
      const wsUrl = (location.origin.replace(/^http/, "ws")) + "/ws/state";
      const wrap = document.getElementById("wrap");
      const line = document.getElementById("centerLine");

      function render(state) {
        wrap.innerHTML = "";
        const enabled = new Set((state.enabled_dancers || []).map(x => (x || "").toLowerCase()));
        const wins = state.win_counts || {};
        const dancers = enabled.size
          ? (state.dancers || []).filter(d => enabled.has((d.name || "").toLowerCase()))
          : (state.dancers || []);

        dancers.forEach(d => {
          const name = d.name || "Unknown";
          const block = document.createElement("div");
          block.className = "block";
          const label = document.createElement("div");
          label.className = "label";
          label.textContent = "DANCER";
          const n = document.createElement("div");
          n.className = "name";
          n.textContent = name;
          const w = document.createElement("div");
          w.className = "wins";
          w.textContent = `Wins: ${wins[name] ?? 0}`;
          block.appendChild(label);
          block.appendChild(n);
          block.appendChild(w);
          wrap.appendChild(block);
        });

        if (!dancers.length) {
          const empty = document.createElement("div");
          empty.className = "block";
          empty.innerHTML = "<div class='label'>NO ENABLED DANCERS</div>";
          wrap.appendChild(empty);
        }

        const overlays = state.overlay_states || {};
        const showLine = overlays.CenterDottedLine !== undefined ? overlays.CenterDottedLine : true;
        line.style.display = showLine ? "block" : "none";
      }

      function bootstrap() {
        fetch("/state").then(r => r.json()).then(render).catch(()=>{});
      }

      let ws;
      function connect() {
        ws = new WebSocket(wsUrl);
        ws.onopen = () => ws.send("ready");
        ws.onmessage = evt => {
          try {
            const data = JSON.parse(evt.data);
            if (data?.type === "state") {
              render(data.payload);
            }
          } catch (e) {}
        };
        ws.onclose = () => setTimeout(connect, 2000);
      }
      connect();
      bootstrap();
    })();
  </script>
</body>
</html>
