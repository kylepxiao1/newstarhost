<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Song Editor</title>
  <style>
    body { font-family: "Segoe UI", Arial, sans-serif; margin: 0; background: #0f172a; color: #e2e8f0; }
    header { padding: 16px 24px; background: #1e293b; box-shadow: 0 2px 6px rgba(0,0,0,.3); display: flex; align-items: center; justify-content: space-between; }
    h1 { margin: 0; font-size: 20px; }
    main { padding: 20px; }
    section { background: #111827; border: 1px solid #1f2937; border-radius: 10px; padding: 16px; margin-bottom: 16px; box-shadow: inset 0 1px 0 rgba(255,255,255,.02); }
    h2 { margin-top: 0; font-size: 16px; }
    .row { display: flex; gap: 8px; margin-bottom: 10px; }
    select, input { padding: 8px; border-radius: 6px; border: 1px solid #334155; background: #0b1222; color: #e2e8f0; flex: 1; }
    button { cursor: pointer; background: #2563eb; color: #fff; border: none; border-radius: 6px; padding: 8px 12px; font-weight: 600; }
  </style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:10px;">
      <h1>Song Editor</h1>
    </div>
  </header>
  <main>
    <section>
      <h2>Select Song</h2>
      <div class="row">
        <input id="songSearch" placeholder="Search song name or dancer" style="flex:1;" oninput="renderSongsList()">
        <select id="songList" style="flex:2;" onchange="loadSong()"></select>
        <button class="secondary" onclick="loadSongs()">Refresh</button>
        <button onclick="playSelected()">Play</button>
      </div>
      <div class="row">
        <input id="renameInput" placeholder="Rename song" style="flex:2;">
        <button onclick="renameSong()">Rename</button>
      </div>
    </section>
  </main>
  <section>
    <h2>Roles</h2>
    <div class="row" id="rolesContainer" style="flex-wrap: wrap; gap:12px;">
    </div>
  </section>
  <section>
    <h2>Edit Dancers</h2>
    <div class="row">
      <label style="width:100%;">Add dancer</label>
    </div>
    <div class="row">
      <input id="dancerSearch" list="dancerSuggestions" placeholder="Search dancer name" style="flex:1;">
      <datalist id="dancerSuggestions"></datalist>
      <button onclick="addTo('dancers')">Add</button>
    </div>
    <div id="dancersList"></div>

    <div class="row" style="margin-top:10px;">
      <label style="width:100%;">Add front dancer</label>
    </div>
    <div class="row">
      <input id="frontSearch" list="frontSuggestions" placeholder="Search dancer name" style="flex:1;">
      <datalist id="frontSuggestions"></datalist>
      <button onclick="addTo('front_dancers')">Add</button>
    </div>
    <div id="frontList"></div>

    <div class="row" style="margin-top:10px;">
      <label style="width:100%;">Add MVP dancer</label>
    </div>
    <div class="row">
      <input id="mvpSearch" list="mvpSuggestions" placeholder="Search dancer name" style="flex:1;">
      <datalist id="mvpSuggestions"></datalist>
      <button onclick="addTo('mvp_dancers')">Add</button>
    </div>
    <div id="mvpList"></div>

    <div class="row" style="margin-top:10px;">
      <label style="width:100%;">Add who knows this song</label>
    </div>
    <div class="row">
      <input id="knowsSearch" list="knowsSuggestions" placeholder="Search dancer name" style="flex:1;">
      <datalist id="knowsSuggestions"></datalist>
      <button onclick="addTo('knows_song')">Add</button>
    </div>
    <div id="knowsList"></div>

    <div class="row" style="margin-top:10px;">
      <button class="danger" onclick="removeSong()">Delete Song</button>
    </div>
  </section>

  <script>
  const api = (p,o={})=>fetch(p,{method:o.method||"GET",headers:{"Content-Type":"application/json"},body:o.body?JSON.stringify(o.body):undefined});
  let songs = {};
  let dancers = [];
  let currentSongId = "";
  let dancersAssigned = [];
  let frontsAssigned = [];
  let mvpsAssigned = [];
  let rolesAssigned = [];
  let knowsAssigned = [];
  const ROLE_OPTIONS = ["bell","applause","mvp","attention","background","win"];

    function renderSongsList() {
      const list = document.getElementById("songList");
      const search = (document.getElementById("songSearch").value || "").toLowerCase();
      list.innerHTML = "";
      Object.keys(songs).forEach(id => {
        const song = songs[id] || {};
        const name = song.name || id;
        const dancersStr = (song.dancers || []).join(" ").toLowerCase() + " " + (song.front_dancers || []).join(" ").toLowerCase();
        if (search && !name.toLowerCase().includes(search) && !dancersStr.includes(search)) return;
        const opt = document.createElement("option");
        opt.value = id;
        opt.textContent = name;
        list.appendChild(opt);
      });
      if (list.options.length) {
        if (currentSongId) {
          const idx = Array.from(list.options).findIndex(o => o.value === currentSongId);
          list.selectedIndex = idx >= 0 ? idx : 0;
        } else {
          list.selectedIndex = 0;
        }
        loadSong();
      }
    }

    function loadSongs() {
      api("/songs").then(r=>r.json()).then(s => {
        songs = s.library || {};
        renderSongsList();
      });
    }

    function loadSong() {
      const list = document.getElementById("songList");
      const id = list.value;
      if (!id) return;
      currentSongId = id;
      const song = songs[id] || {};
      dancersAssigned = [...(song.dancers || [])];
      frontsAssigned = [...(song.front_dancers || [])];
      mvpsAssigned = [...(song.mvp_dancers || [])];
      rolesAssigned = [...(song.roles || [])];
      knowsAssigned = [...(song.knows_song || [])];
      document.getElementById("renameInput").value = song.name || id || "";
      renderLists();
      renderPreview();
      renderRoles();
    }

  function save() {
      const btns = document.querySelectorAll("button");
      btns.forEach(b=>b.disabled=true);
      if (!currentSongId) { btns.forEach(b=>b.disabled=false); return; }
      const newName = document.getElementById("renameInput").value.trim();
      const doRename = newName && (!songs[currentSongId] || songs[currentSongId].name !== newName);
      const renamePromise = doRename
        ? api("/songs/rename", {method:"POST", body:{song_id: currentSongId, name: newName}}).then(r=>r.json())
        : Promise.resolve(null);
      renamePromise
        .then(state => {
          if (state && state.library) {
            songs = state.library;
          }
          return api("/songs/update_dancers", {method:"POST", body:{song_id: currentSongId, dancers: dancersAssigned, front_dancers: frontsAssigned, mvp_dancers: mvpsAssigned, roles: rolesAssigned, knows_song: knowsAssigned}});
        })
        .then(()=>loadSongs())
        .finally(()=>btns.forEach(b=>b.disabled=false));
    }

    function renameSong() {
      if (!currentSongId) return;
      const newName = document.getElementById("renameInput").value.trim();
      if (!newName) return;
      api("/songs/rename", {method:"POST", body:{song_id: currentSongId, name: newName}})
        .then(r=>r.json())
        .then(state => {
          if (state && state.library) songs = state.library;
          renderSongsList();
        });
    }

    function removeSong() {
      if (!currentSongId) return;
      if (!confirm("Are you sure you want to delete this song?")) return;
      const btns = document.querySelectorAll("button");
      btns.forEach(b=>b.disabled=true);
      api("/songs/delete", {method:"POST", body:{song_id: currentSongId}})
        .then(()=>{currentSongId=""; dancersAssigned=[]; frontsAssigned=[]; mvpsAssigned=[]; renderLists(); loadSongs();})
        .finally(()=>btns.forEach(b=>b.disabled=false));
    }

  function renderPreview() {
    // Preview removed; no-op to keep compatibility
  }

  function getAudioPlayer() {
    if (window.top && window.top !== window) {
      const gp = window.top.document.getElementById("globalPlayer");
      if (gp) return gp;
    }
    if (!window._sharedAudio) window._sharedAudio = new Audio();
    return window._sharedAudio;
  }

  function playSelected() {
    const id = document.getElementById("songList").value;
    if (!id) return;
    const song = songs[id] || {};
    if (!song.url) return;
    const audio = getAudioPlayer();
    audio.src = song.url;
    audio.loop = false;
    audio.play().catch(()=>{});
  }

    function loadDancers() {
      api("/dancers").then(r=>r.json()).then(d => {
        dancers = d || [];
        loadSongs();
      });
    }

    function addTo(field) {
      const inputId = field === "dancers" ? "dancerSearch" : field === "front_dancers" ? "frontSearch" : field === "mvp_dancers" ? "mvpSearch" : "knowsSearch";
      const val = document.getElementById(inputId).value.trim();
      if (!val) return;
      if (field === "dancers" && !dancersAssigned.includes(val)) dancersAssigned.push(val);
      if (field === "front_dancers" && !frontsAssigned.includes(val)) frontsAssigned.push(val);
      if (field === "mvp_dancers" && !mvpsAssigned.includes(val)) mvpsAssigned.push(val);
      if (field === "knows_song" && !knowsAssigned.includes(val)) knowsAssigned.push(val);
      renderLists();
      save();
    }

    function removeFrom(field, name) {
      if (field === "dancers") dancersAssigned = dancersAssigned.filter(x=>x!==name);
      if (field === "front_dancers") frontsAssigned = frontsAssigned.filter(x=>x!==name);
      if (field === "mvp_dancers") mvpsAssigned = mvpsAssigned.filter(x=>x!==name);
      if (field === "knows_song") knowsAssigned = knowsAssigned.filter(x=>x!==name);
      renderLists();
      save();
    }

    function renderLists() {
      populateList("dancersList", dancersAssigned, "dancers");
      populateList("frontList", frontsAssigned, "front_dancers");
      populateList("mvpList", mvpsAssigned, "mvp_dancers");
      populateList("knowsList", knowsAssigned, "knows_song");
      populateSuggestions();
      renderRoles();
    }

    function renderRoles() {
      const c = document.getElementById("rolesContainer");
      c.innerHTML = "";
      ROLE_OPTIONS.forEach(role => {
        const wrap = document.createElement("label");
        wrap.style.display = "flex";
        wrap.style.alignItems = "center";
        wrap.style.gap = "6px";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = rolesAssigned.includes(role);
        cb.onchange = () => toggleRole(role, cb.checked);
        const span = document.createElement("span");
        span.textContent = role;
        wrap.appendChild(cb);
        wrap.appendChild(span);
        c.appendChild(wrap);
      });
    }

    function toggleRole(role, checked) {
      const set = new Set(rolesAssigned);
      if (checked) set.add(role); else set.delete(role);
      rolesAssigned = Array.from(set);
      save();
    }

    function populateList(containerId, arr, field) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      arr.forEach(name => {
        const div = document.createElement("div");
        div.className = "row";
        div.innerHTML = `<span>${name}</span><button onclick="removeFrom('${field}','${name}')">Remove</button>`;
        container.appendChild(div);
      });
    }

    function populateSuggestions() {
      ["dancerSuggestions","frontSuggestions","mvpSuggestions","knowsSuggestions"].forEach(id=>{
        const dl = document.getElementById(id);
        dl.innerHTML = "";
        dancers.forEach(d=>{
          const opt = document.createElement("option");
          opt.value = d.name;
          opt.label = `${d.name} (${d.handle})`;
          dl.appendChild(opt);
        });
      });
    }

    function highlightNav() {
      let here = location.pathname.replace(/\/+$/,"");
      if (!here) here = "/";
      const links = Array.from(document.querySelectorAll(".nav-bar a"));
      let best = null;
      links.forEach(a => {
        let link = (a.getAttribute("href") || "").replace(/\/+$/,"");
        if (!link) link = "/";
        if (here === link || here.startsWith(link)) {
          if (!best || link.length > best.href.length) best = {el:a, href:link};
        }
      });
      links.forEach(a => a.classList.remove("active"));
      if (best) best.el.classList.add("active");
    }

    loadDancers();
    highlightNav();
  </script>
</body>
</html>
