<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dance Menu</title>
  <style>
    body { font-family: "Segoe UI", Arial, sans-serif; margin: 0; background: #0f172a; color: #e2e8f0; padding: 20px; }
    section { background: #111827; border: 1px solid #1f2937; border-radius: 10px; padding: 16px; margin-bottom: 16px; }
    h1, h2 { margin: 0 0 10px 0; }
    .row { display: flex; gap: 8px; margin-bottom: 10px; }
    button { cursor: pointer; background: #2563eb; color: #fff; border: none; border-radius: 6px; padding: 8px 12px; font-weight: 600; }
    select, input { padding: 8px; border-radius: 6px; border: 1px solid #334155; background: #0b1222; color: #e2e8f0; flex: 1; }
    .songs { display: flex; gap: 8px; flex-wrap: wrap; }
    .card { background: #0b1222; border: 1px solid #1f2937; border-radius: 8px; padding: 10px; min-width: 200px; }
    .card h3 { margin: 0 0 6px 0; font-size: 14px; }
  </style>
</head>
<body>
  <h1>Dance Menu</h1>
  <section>
    <h2>Filters</h2>
    <div class="row">
      <input id="dancerFilter" placeholder="Filter by dancer" oninput="renderSongs()">
      <button onclick="refreshData()">Refresh</button>
    </div>
  </section>

  <section>
    <h2>All Songs</h2>
    <div id="songsContainer" class="songs"></div>
  </section>

  <section>
    <h2>Playback Controls</h2>
    <div class="row">
      <input id="randomDancerInput" placeholder="Registered dancer for random pick" list="registeredDancers" style="flex:1;">
      <datalist id="registeredDancers"></datalist>
      <button onclick="playRandomForDancer()">Play Random for Dancer</button>
    </div>
    <div class="row">
      <input id="songFilter" placeholder="Search songs" style="flex:1;" list="songSuggestions" oninput="renderSongs()" onchange="filterSelected()">
      <datalist id="songSuggestions"></datalist>
    </div>
    <div class="row">
      <select id="songSelect" style="flex:1;"></select>
      <button onclick="playSong()">Play Song</button>
    </div>
    <div class="row" style="align-items:center;">
      <label style="display:flex;gap:6px;align-items:center;">
        <input type="checkbox" id="fadeToggle" checked> Fade in 0.5s
      </label>
      <label style="display:flex;gap:6px;align-items:center;">
        <input type="checkbox" id="fadeOutToggle" checked> Fade out 0.5s
      </label>
    </div>
    <div class="row" style="align-items:center;">
      <span style="min-width:120px;">Current song:</span>
      <span id="currentSongLabel">None</span>
    </div>
    <audio id="player" preload="auto" controls style="width:100%;"></audio>
  </section>

  <script>
    const api = (p,o={})=>fetch(p,{method:o.method||"GET",headers:{"Content-Type":"application/json"},body:o.body?JSON.stringify(o.body):undefined});
    let library = {};
    let songsState = {};
    let state = {};
    let currentUrl = "";
    let backgroundStarted = false;
    let dancersList = [];
    let playCounts = loadPlayCounts();
    let lastSongUrl = loadLastSong();

    async function refreshData() {
      const songs = await api("/songs").then(r=>r.json());
      songsState = songs || {};
      library = songs.library || {};
      try {
        const dancersResp = await api("/dancers").then(r=>r.json());
        if (Array.isArray(dancersResp)) {
          dancersList = dancersResp.map(d => typeof d === "string" ? d : (d?.name || "")).filter(Boolean);
        } else if (dancersResp && typeof dancersResp === "object") {
          dancersList = Object.keys(dancersResp || {});
        } else {
          dancersList = [];
        }
      } catch (e) {
        dancersList = [];
      }
      renderDancerDatalist();
      renderSongs();
      ensureBackground();
    }

    function renderDancerDatalist() {
      const dl = document.getElementById("registeredDancers");
      if (!dl) return;
      dl.innerHTML = "";
      dancersList.sort((a,b)=>a.localeCompare(b)).forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        dl.appendChild(opt);
      });
    }

    function renderSongs() {
      const container = document.getElementById("songsContainer");
      const baseFilter = (s) => {
        const hasRole = (s.roles || []).length > 0;
        const hasDancers = (s.dancers || []).length > 0;
        return !hasRole && hasDancers;
      };
      if (container) {
        container.innerHTML = "";
        const dancerFilter = (document.getElementById("dancerFilter")?.value || "").toLowerCase();
        Object.values(library)
          .filter(baseFilter)
          .filter(s => {
            if (!dancerFilter) return true;
            const all = [...(s.dancers||[]), ...(s.front_dancers||[]), ...(s.knows_song||[])];
            return all.some(n => (n||"").toLowerCase().includes(dancerFilter));
          })
          .sort((a,b)=> (a.name||"").localeCompare(b.name||""))
          .forEach(song => {
            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `<h3>${song.name||"Unnamed"}</h3><div>Front: ${(song.front_dancers||[]).join(", ")||"-"}<br>Dancers: ${(song.dancers||[]).join(", ")||"-"}</div>`;
            const playBtn = document.createElement("button");
            playBtn.textContent = "Play Song";
            playBtn.onclick = () => playSongWithUrl(song.url);
            card.appendChild(playBtn);
            container.appendChild(card);
          });
      }

      const songs = songsState || {};
      const lib = songs.library || {};
      const currentUrlLocal = songs.current || "";
      const backgroundUrlLocal = songs.background || "";
      const filter = (document.getElementById("songFilter")?.value || "").toLowerCase();
      const tabFilter = (state.group_name || "").toLowerCase();
      const datalist = document.getElementById("songSuggestions");
      if (datalist) datalist.innerHTML = "";
      let currentName = "None";
      const tryResolve = (url) => {
        let name = "None";
        Object.values(lib).forEach(item => {
          if (item.url === url) {
            name = item.name || url;
          }
        });
        if (name === "None" && url && url === backgroundUrlLocal) {
          name = "Background";
        }
        if (name === "None" && url) name = url;
        return name;
      };
      if (currentUrlLocal) {
        currentName = tryResolve(currentUrlLocal);
      } else if (backgroundUrlLocal) {
        currentName = tryResolve(backgroundUrlLocal);
      }
      const currentLabel = document.getElementById("currentSongLabel");
      if (currentLabel) currentLabel.textContent = currentName;
      const select = document.getElementById("songSelect");
      if (select) {
        select.innerHTML = "";
        Object.keys(lib).forEach(key => {
          const song = lib[key];
          if (!baseFilter(song)) return;
          const opt = document.createElement("option");
          opt.value = song.url;
          let label = song.name || key;
          const fronts = (song.front_dancers || []).join(", ");
          if (fronts) {
            label += ` (Front: ${fronts})`;
          }
          opt.textContent = label;
          const dancerMatch = tabFilter
            ? (song.dancers || []).some(d => (d || "").toLowerCase().includes(tabFilter))
            : true;
          const matches = (!filter || label.toLowerCase().includes(filter)) && dancerMatch;
          if (matches) {
            select.appendChild(opt);
          }
          if (matches && datalist) {
            const dOpt = document.createElement("option");
            dOpt.value = label;
            datalist.appendChild(dOpt);
          }
        });
        if (!select.value && select.options.length) select.selectedIndex = 0;
      }
    }

    function filterSelected() {
      const filterVal = (document.getElementById("songFilter")?.value || "").toLowerCase();
      const select = document.getElementById("songSelect");
      if (!select) return;
      for (let i = 0; i < select.options.length; i++) {
        if (select.options[i].textContent.toLowerCase() === filterVal) {
          select.selectedIndex = i;
          playSong(true);
          break;
        }
      }
    }

    function selectTab(tab) {
      renderSongs();
    }

    async function playSong(fromSelect=false) {
      const select = document.getElementById("songSelect");
      const url = select ? select.value : "";
      playSongWithUrl(url, fromSelect);
    }

    function playSongWithUrl(url, fromSelect=false) {
      if (!url) {
        if (fromSelect) return;
        return alert("Select a song");
      }
      api("/songs/play", {method:"POST", body:{target: "group", url}}).catch(()=>{});
      if (!songsState) songsState = {};
      songsState.current = url;
      const bellUrl = getRoleUrl("bell");
      // bell -> song -> applause -> background (loop)
      const steps = [];
      if (bellUrl) steps.push(bellUrl);
      steps.push(url);
      steps.push("applause_role");
      steps.push("background_role");
      playSequence(steps);
      refreshState();
    }

    function startAudio(url, opts={}) {
      const player = document.getElementById("player");
      const fadeIn = opts.fade ?? document.getElementById("fadeToggle")?.checked ?? true;
      const fadeOut = opts.fadeOut ?? document.getElementById("fadeOutToggle")?.checked ?? true;
      const doPlay = () => {
        try { player.pause(); } catch(e){}
        player.loop = !!opts.loop;
        player.onended = () => {
          if (typeof opts.onEnd === "function") {
            opts.onEnd();
            return;
          }
        };
        player.src = url;
        if (!opts.isRole) {
          notePlay(url);
        }
        if (fadeIn) {
          let vol = 0.0;
          player.volume = 0;
          player.play().catch(()=>{});
          const steps = 10;
          const stepMs = 50;
          const inc = 1/steps;
          let count = 0;
          const intv = setInterval(()=>{
            count += 1;
            vol = Math.min(1, vol + inc);
            player.volume = vol;
            if (count >= steps) clearInterval(intv);
          }, stepMs);
        } else {
          player.volume = 1;
          player.play().catch(()=>{});
        }
      };
      if (fadeOut && !opts.skipFadeOut && !player.paused && player.src) {
        let vol = player.volume;
        const steps = 10;
        const stepMs = 50;
        const dec = vol/steps;
        let count = 0;
        const outv = setInterval(()=>{
          count += 1;
          vol = Math.max(0, vol - dec);
          player.volume = vol;
          if (count >= steps) {
            clearInterval(outv);
            player.pause();
            doPlay();
          }
        }, stepMs);
      } else {
        doPlay();
      }
    }

    function getRoleUrl(role) {
      return Object.values(library).find(s => (s.roles||[]).includes(role))?.url || "";
    }

    function setCurrent(url) {
      currentUrl = url;
      const label = document.getElementById("currentSongLabel");
      let name = "None";
      Object.values(library).forEach(s => { if (s.url === url) name = s.name || url; });
      if (!url) name = "None";
      if (label) label.textContent = name;
    }

    function playSequence(steps) {
      if (!steps || !steps.length) return;
      const [first, ...rest] = steps.filter(Boolean);
      if (!first) return;
      let url = first;
      let isRole = false;
      if (first === "applause_role") {
        url = getRoleUrl("applause");
        if (!url) { playSequence(rest); return; }
        isRole = true;
      } else if (first === "background_role") {
        url = getRoleUrl("background");
        if (!url) { playSequence(rest); return; }
        songsState.background = url;
        setCurrent(url);
        startAudio(url, {loop:true, fade:false, fadeOut:false, skipFadeOut:true, isRole:true});
        return;
      }
      // normal audio
      setCurrent(url);
      startAudio(url, {loop:false, fade:true, fadeOut:false, skipFadeOut:true, isRole, onEnd: () => playSequence(rest)});
    }

    function playRandomForDancer() {
      const raw = (document.getElementById("randomDancerInput")?.value || "").trim();
      if (!raw) {
        alert("Select a registered dancer");
        return;
      }
      const match = dancersList.find(d => d.toLowerCase() === raw.toLowerCase());
      if (!match) {
        alert("Select a registered dancer");
        return;
      }
      const name = match.toLowerCase();
      const pool = Object.values(library).filter(s => (s.dancers||[]).some(d => (d||"").toLowerCase() === name));
      if (!pool.length) {
        alert("No songs found for that dancer");
        return;
      }
      const choice = pickRandomWeighted(pool);
      if (choice?.url) {
        playSongWithUrl(choice.url);
      }
    }

    function ensureBackground() {
      if (backgroundStarted) return;
      const bg = getRoleUrl("background");
      if (!bg) return;
      backgroundStarted = true;
      setCurrent(bg);
      startAudio(bg, {loop:true, fade:false, fadeOut:false, skipFadeOut:true, isRole:true});
    }

    function loadPlayCounts() {
      try {
        const raw = localStorage.getItem("playCounts");
        return raw ? JSON.parse(raw) : {};
      } catch (e) { return {}; }
    }
    function savePlayCounts() {
      try { localStorage.setItem("playCounts", JSON.stringify(playCounts)); } catch (e) {}
    }
    function loadLastSong() {
      try { return localStorage.getItem("lastSongUrl") || ""; } catch (e) { return ""; }
    }
    function saveLastSong(url) {
      lastSongUrl = url || "";
      try { localStorage.setItem("lastSongUrl", lastSongUrl); } catch (e) {}
    }
    function notePlay(url) {
      if (!url) return;
      playCounts[url] = (playCounts[url] || 0) + 1;
      savePlayCounts();
      saveLastSong(url);
    }

    function pickRandomWeighted(pool) {
      if (!pool?.length) return null;
      const processed = pool.map(item => {
        const key = typeof item === "string" ? item : (item?.url || item?.id || null);
        const count = key ? (playCounts[key] || 0) : 0;
        return { item, key, count };
      });
      let candidates = processed;
      if (processed.length > 1 && lastSongUrl) {
        const filtered = processed.filter(p => p.key && p.key !== lastSongUrl);
        if (filtered.length) candidates = filtered;
      }
      const weights = candidates.map(p => p.key ? 1 / (1 + p.count) : 1);
      const total = weights.reduce((a,b)=>a+b,0);
      let r = Math.random() * total;
      for (let i=0;i<candidates.length;i++) {
        r -= weights[i];
        if (r <= 0) return candidates[i].item;
      }
      return candidates[candidates.length-1].item;
    }

    refreshData();
    refreshState();
    refreshSongs();
  </script>
</body>
</html>
